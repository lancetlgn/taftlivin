<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="generator" content="Hugo 0.84.0">
        <title> TaftLivin' Forum </title>
        <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/album/">
        <link rel="stylesheet" href="../style.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

        <style>

            .list-group-item.active{

            background-color: #169754;    

            }

            .list-group-item:hover{

            color: green;

            }

            .text-muted.active {

            color: white ;
            opacity: 1 ; 

            }

            .page-link{

            color:#169754;

            }

            .btn.btn-outline-success:hover{

            background-color:#169754;
            color: white;

            }

            .topic{

            padding-left: 125px;

            }

            .jumbotron.jumbotron-fluid{

            background-color: aliceblue;

            }

            .d-flex.p-2{

            background-color: rgb(255, 255, 255);
            margin: 100px;
            margin-top: 10px;
            margin-bottom: 0;
            font-size: large;
            border-radius: 10px;
            box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.1); 
            width: 70%;

            }

            .d-flex.p-2.first{

            background-color: rgb(255, 255, 255);
            margin: 100px;
            margin-top: 30px;
            margin-bottom: 0;
            font-size: large;
            border-radius: 10px;
            box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.1); 
            width: 70%;

            }

            .d-flex.p-2.side{
            display: flex;
            position: fixed;
            background-color: rgb(255, 255, 255);
            margin: 100px;
            margin-top: 30px;
            margin-bottom: 0;
            right: 0;
            top: 145px;
            font-size: medium;
            border-radius: 10px;
            box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.1); 
            width: 15%;    
            height: 50%;
            flex-direction: column;
            }

            .rounded-circle.pfp{

            width: 5%;
            height: 5%;
            padding-top: 3px;

            }

            .forum-background{

                position: fixed;
                top: 0;
                left: 0;
                width: 100;
                min-height: 100vh;
                background-image: url("../../images/ls-bg-blur.png");

            }

            html, body {
                overflow-y: auto; /* Enables vertical scrolling */
                overflow-x: hidden; /* Prevents horizontal scrolling */
                height: 100vh;
            }

            .flex-container{

                display: flex;
                flex-wrap: wrap; /* Allows items to wrap */
                max-height: 600px; /* Prevents clipping */
                overflow-y: auto; /* Enables scrolling */
                padding-bottom: 10px;

            }

            .text-field.reply{

                font-size: 16px;
                border: 1px solid #ffffff;
                border-radius: 0px;
                width: 100%;
                height: 100%;
                box-sizing: border-box;
                resize: none;
                flex-grow: 1;
                min-height: 370px;

            }

            .post-button {
                font-size: larger;
                position: fixed;
                right: 100px;
                top: 600px;
                padding: 20px 36px;
                font-size: 16px;
                background-color: #3f9c42;
                color: white;
                border: 2px solid #ffffff;
                border-radius: 15px;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }

            .post-button:hover {

                background-color: white;
                color:black;
                border: 2px solid rgb(27, 111, 27);

            }

        </style>

    </head>
    <body>

        <nav id="navbar" class="navbar navbar-expand-md navbar-dark fixed-top bg-success fw-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="../../index.html">TaftLivin'</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav me-auto mb-2 mb-md-0">
                        <li class="nav-item">
                            <a class="nav-link" href="../index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="about.html">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="condos.html">Condos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page"  href="forum.html">Forum</a>
                        </li>
                    </ul>
                    <div class="d-flex">
                        <a href="signin.html" class="btn btn-light ms-2">Sign In</a>
                        <a href="signup.html" class="btn btn-outline-light ms-2">Sign Up</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="forum-background" id="bg-image-container">
            <br>
            <br>
            <br>
            <br>
                <div class="topic">
                    <h1 id="topic">
                    </h1>
                </div>
                <div class="d-flex p-2 side">

                    <form id="addReplyForm">
                        <textarea type="text" id="addReplyContent" class="text-field reply" placeholder="Enter your reply here" required></textarea>
                    </form>
    
                </div>
                <button type="submit" form="addReplyForm" class="post-button" id="postBtn">Reply</button>
                <div class="flex-container" style="align-items: flex-start;" id="reply-container">

                </div>
                
        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="../js/api.js"></script>
        <script src="../js/auth-ui.js"></script>
        <script>

            document.addEventListener('DOMContentLoaded', function() {
            // Update authentication UI if the function is available
                if (typeof updateAuthUI === 'function') {
                    updateAuthUI();
                }

                loadTopic();

            /*    document.getElementById('postBtn').addEventListener('click', function() {
                    event.preventDefault(); // Prevent default form submission
                    console.log('recieved');
                }); */

                document.getElementById('addReplyForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const replyContent = document.getElementById('addReplyContent').value;
                var selectedTopic = JSON.parse(localStorage.getItem("selectedTopic"));
                console.log('recieved');

                const replyData = {
                    content: replyContent,
                };
                
                const topicData = {

                    replies: [...(selectedTopic?.replies || []), replyData],

                };
                
                try {
                    // Create condo via API
                    if (!selectedTopic._id) {
                        console.error("No valid selectedTopic found in localStorage.");
                    } else {
                        localStorage.setItem("selectedTopic", JSON.stringify(await api.auth.createReply(selectedTopic._id, topicData)));
                    }

                    // Clear form
                    this.reset();
                    
                    // Reload topic
                    window.location.reload(true);
                    
                    alert('Reply added successfully!');
                } catch (error) {
                    
                    alert('Error: ' + error.message);
                }
            });

            });

            async function loadTopic() {
                try {
                    // Show loading state
                    const selectedTopic = JSON.parse(localStorage.getItem("selectedTopic"));

                    const topic = document.getElementById('topic');
    
                    
                    if (!selectedTopic) {
                        throw new Error(data.message || 'Failed to load topics');
                    }
                    
                    // Display topics
                    displayReplies(selectedTopic);
                    
                    
                } catch (error) {
                    console.error('Error loading topic:', error);
                    document.getElementById('topic').innerHTML = `
                        <div class="alert alert-danger">
                            Error loading topic: ${error.message}
                            <button class="btn btn-sm btn-danger ms-2" onclick="loadTopic()">Retry</button>
                        </div>
                    `;
                }
            }

            function displayReplies(topic) {
                const topicDiv = document.getElementById('topic');
                const replyContainer = document.getElementById('reply-container')


                topicDiv.innerHTML = `
                    ${topic.title}
                    `;
                
                
                
                // Clear container
                replyContainer.innerHTML = '';
                
                // Add each condo
                topic.replies.forEach((reply, index) => {
                    const replyItem = document.createElement('div');
                    username = 'User'

                    if (index == 0){
                        replyItem.className = 'd-flex p-2 first';
                    } else {
                        replyItem.className = 'd-flex p-2';
                    }
                    
                    const formattedDate = topic.datePosted.split("T")[0];

                    replyItem.innerHTML = `
                        <p style="padding-left: 10px;">${username}:<br>${reply.content}</p>
                        <p style="margin-left: auto; padding-right: 10px; font-size: smaller;">Posted on ${formattedDate}</p>
                    `;
                    
                    replyContainer.appendChild(replyItem);
                });
            }



        </script>
    </body>